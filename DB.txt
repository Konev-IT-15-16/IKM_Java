-- Очистка таблиц (опционально)
drop table authors cascade ;
drop table books cascade ;
drop table genres cascade ;
drop table book_genres cascade ;
-- create database library_db;
-- Создание таблицы authors
CREATE TABLE IF NOT EXISTS authors (
                                       id BIGSERIAL PRIMARY KEY,
                                       first_name VARCHAR(50) NOT NULL,
                                       last_name VARCHAR(50) NOT NULL,
                                       birth_date DATE,
                                       bio TEXT,
                                       created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                       updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Создание таблицы books
CREATE TABLE IF NOT EXISTS books (
                                     id BIGSERIAL PRIMARY KEY,
                                     title VARCHAR(200) NOT NULL,
                                     author_id BIGINT NOT NULL,
                                     isbn VARCHAR(20) UNIQUE,
                                     publication_year INTEGER CHECK (publication_year >= 1000 AND publication_year <= 2100),
                                     price DECIMAL(10, 2) CHECK (price >= 0),
                                     page_count INTEGER CHECK (page_count > 0),
                                     description TEXT,
                                     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                                     updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

                                     CONSTRAINT fk_author
                                         FOREIGN KEY (author_id)
                                             REFERENCES authors(id)
                                             ON DELETE CASCADE
);

-- Создание таблицы genres
CREATE TABLE IF NOT EXISTS genres (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(500)
);

CREATE TABLE book_genres (
                             book_id BIGINT NOT NULL,
                             genre_id BIGINT NOT NULL,

                             PRIMARY KEY (book_id, genre_id),

                             CONSTRAINT fk_book
                                 FOREIGN KEY (book_id)
                                     REFERENCES books (id)
                                     ON DELETE CASCADE,

                             CONSTRAINT fk_genre
                                 FOREIGN KEY (genre_id)
                                     REFERENCES genres (id)
                                     ON DELETE CASCADE
);

-- Индексы для оптимизации
CREATE INDEX IF NOT EXISTS idx_books_author_id ON books(author_id);


-- Вставка авторов
INSERT INTO authors (first_name, last_name, birth_date, bio) VALUES
                                                                        ('Лев', 'Толстой','1828-09-09', 'Русский писатель'),
                                                                        ('Фёдор', 'Достоевский', '1821-11-11', 'Русский писатель'),
                                                                        ('Антон', 'Чехов', '1860-01-29', 'Русский писатель');

-- Вставка книг
INSERT INTO books (title, author_id, isbn, publication_year, price, page_count, description) VALUES
                                                                                                 ('Война и мир', 1, '978-5-389-00001-1', 1869, 1200.00, 1225, 'Роман-эпопея'),
                                                                                                 ('Анна Каренина', 1, '978-5-389-00002-2', 1877, 1000.00, 864, 'Роман о любви'),
                                                                                                 ('Преступление и наказание', 2, '978-5-389-00003-3', 1866, 800.00, 671, 'Психологический роман'),
                                                                                                 ('Вишневый сад', 3, '978-5-389-00004-4', 1904, 500.00, 120, 'Пьеса')
ON CONFLICT (isbn) DO NOTHING;

-- Вставка отзывов
INSERT INTO genres (name, description) VALUES
                                           ('Роман', 'Художественное повествовательное произведение'),
                                           ('Классика', 'Произведения, признанные эталонными'),
                                           ('Антиутопия', 'Произведения о мрачном будущем'),
                                           ('Фантастика', 'Научная и социальная фантастика');

INSERT INTO book_genres (book_id, genre_id) VALUES
                                                (1, 1),
                                                (1, 2),
                                                (2, 1),
                                                (3, 3),
                                                (4, 4);